name: Reopen mistake PR once

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

jobs:
  reopen:
    runs-on: ubuntu-latest
    steps:
      - name: Reopen PR once
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;

            // Only PR comments
            if (!issue.pull_request) return;

            // Exact command only
            if (comment.body.trim() !== '/not-a-mistake') return;

            const prResp = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });

            const pr = prResp.data;

            // Only PR author can reopen
            if (comment.user.login !== pr.user.login) return;

            // Must be closed and not merged
            if (pr.state !== 'closed' || pr.merged) return;

            const labels = pr.labels.map(l => l.name);

            // Must be eligible
            if (
              !labels.includes('mistake-pr') ||
              labels.includes('reopen-used') ||
              labels.includes('reopen-locked')
            ) return;

            // Attempt reopen FIRST
            try {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issue.number,
                state: 'open'
              });
            } catch (err) {
              // Reopen failed â€” do not consume the retry
              console.error('Failed to reopen PR:', err);
              return;
            }

            // Mark reopen as used ONLY after success
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['reopen-used']
            });

            // Remove mistake label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: 'mistake-pr'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `PR reopened. If this PR is closed again, it cannot be reopened.`
            });
