name: Reopen mistake PR once

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

jobs:
  reopen:
    runs-on: ubuntu-latest
    steps:
      - name: Reopen PR once
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;

            // Must be a PR
            if (!issue.pull_request) return;

            // Exact command
            if (comment.body.trim() !== '/not-a-mistake') return;

            // Fetch PR
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });

            // Must be closed and not merged
            if (pr.data.state !== 'closed' || pr.data.merged) return;

            // Only PR author can reopen
            if (comment.user.login !== pr.data.user.login) return;

            const labels = pr.data.labels.map(l => l.name);

            // Must be a mistake PR and not already used or locked
            if (
              !labels.includes('mistake-pr') ||
              labels.includes('reopen-used') ||
              labels.includes('reopen-locked') ||
              labels.includes('admin-overridden')
            ) return;

            // Mark reopen as used FIRST (prevents race condition)
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['reopen-used']
            });

            // Remove mistake label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: 'mistake-pr'
            });

            // Reopen PR
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number,
              state: 'open'
            });

            // Notify
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body:
                "PR reopened.\n\n" +
                "If this PR is closed again, it cannot be reopened automatically."
            });
