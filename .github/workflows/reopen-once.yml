name: Reopen mistake PR once

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

jobs:
  reopen:
    runs-on: ubuntu-latest
    steps:
      - name: Reopen PR once
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;

            // Only run on PR comments
            if (!issue.pull_request) return;

            // Exact command only
            if (comment.body.trim() !== '/not-a-mistake') return;

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });

            // Only the PR author can reopen
            if (comment.user.login !== pr.data.user.login) return;

            const labels = pr.data.labels.map(l => l.name);

            // Must be a mistake PR and not already used/locked
            if (
              !labels.includes('mistake-pr') ||
              labels.includes('reopen-used') ||
              labels.includes('reopen-locked')
            ) return;

            // Reopen PR
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number,
              state: 'open'
            });

            // Mark reopen as used
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['reopen-used']
            });

            // Remove mistake label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: 'mistake-pr'
            });

            // Notify author
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `✅ PR reopened. ⚠️ If this PR is closed again, it cannot be reopened.`
            });
