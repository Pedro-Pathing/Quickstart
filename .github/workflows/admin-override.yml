name: Admin override PR lock

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  override:
    runs-on: ubuntu-latest
    steps:
      - name: Admin override
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;

            if (!issue.pull_request) return;
            if (comment.body.trim() !== '/admin-override') return;

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue.number
            });

            if (pr.data.merged) return;

            const perm = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: comment.user.login
            });

            if (!['admin', 'maintain'].includes(perm.data.permission)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Admin override denied. Maintainers only.'
              });
              return;
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['admin-overridden']
            });

            // Try to remove permanent-lock and related labels so an admin can override
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'reopen-locked'
              });
            } catch (e) {}

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'reopen-used'
              });
            } catch (e) {}

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'mistake-pr'
              });
            } catch (e) {}

            try {
              await github.rest.issues.unlock({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
            } catch {}

            if (pr.data.state === 'closed') {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issue.number,
                state: 'open'
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body:
                "**Admin override applied.**\n\n" +
                "This PR is no longer subject to the mistake-PR lock or the permanent lock.\n\n" +
                "Labels cleaned: `reopen-locked`, `reopen-used`, `mistake-pr` (if present)."
            });
